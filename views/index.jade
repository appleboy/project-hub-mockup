extends _template

block head

block title

block body

  nav#sidebar
    .ui.menu.no.margin
      .ui.dropdown.item for Asperger's
        i.icon.dropdown
        .menu
          a.item Human mode
          a.item Asperger mode
          a.item Charts
      .right.menu
        .ui.dropdown.icon.item
          i.icon.ellipsis.vertical
          .menu
            .item
              i.icon.add
              | Submit a project
            .item
              i.icon.pencil
              | Edit pending data
            .item
              i.icon.help
              | About
    #search.field
      .ui.icon.input
        input(placeholder="search...", type="text")
        i.icon.search
    #index.ui.vertical.fluid.menu.no.margin
      #category.ui.accordion
        .title.header.item.active category
          i.icon.dropdown
        .content.ui.small.menu.active
          .menu
      #type.ui.accordion
        .title.header.item type
          i.icon.dropdown
        .content.ui.small.menu
          .menu
      #phase.ui.accordion
        .title.header.item phase
          i.icon.dropdown
        .content.ui.small.menu
          .menu
      #license.ui.accordion
        .title.header.item license
          i.icon.dropdown
        .content.ui.small.menu
          .menu
      #tool.ui.accordion
        .title.header.item tool
          i.icon.dropdown
        .content.ui.small.menu
          .menu
      #tag.ui.accordion
        .title.header.item tag
          i.icon.dropdown
        .content.ui.small.menu
          .menu

  section#projects.views
    #filter
    #count
    #list.ui.two.column.stackable.grid
      //-article.column.category-1
        a.ui.image(href="")
          img(src="")
        .text
          h3.ui.header 求職小幫手
          p.description blah blah
          p.achievement
            a.ui.label(href="") blah
        .hidden.text hidden
  section#about.views
    .ui.header.align.center g0v.tw Project Pilot
    .ui.divider
    p.align.center
      a(href="https://github.com/g0v/project-hub-mockup", target="_blank") The source code is on github here.
        i.icon.forward.mail
    p.align.center
      a(href="https://github.com/g0v/project-hub-mockup/blob/master/livescripts/projectlist_20141009.json.ls", target="_blank") To complete the data, please edit this .ls file,
        i.icon.forward.mail
    p.align.center
      a(href="https://github.com/g0v/project-hub-mockup/blob/master/public/json/project-list.json", target="_blank") and I will convert it to this .json file.
        i.icon.forward.mail
    p.align.center
      a(href="http://g0v.github.io/project-hub-mockup/public/", target="_blank") And this webpage will be updated after deploying.
        i.icon.forward.mail
    p.align.center
      a(href="https://github.com/g0v/project-hub-mockup/issues", target="_blank") If you are familiar with javascript, please help me with these issues.
        i.icon.forward.mail
    p.align.center
      a(href="https://g0v.hackpad.com/hQ9RdcSw7Gd", target="_blank") For more info, please check out this hackpad
        i.icon.forward.mail
    p.align.center We can discuss this project on irc.freenode.net#g0v.tw
      br
      | (mention ipa, jimyhuang, Lee1092, ETBlue)
  section#submit.views
    .ui.header.align.center Submit a g0v Project
    p.align.center this is not working yet! don't submit true data or you will blame me...
    .ui.divider
    form.ui.warning.form
      .two.fields
        .field
          label 專案中文名稱
          .ui.input
            input(name="name-zh",required)
            .ui.corner.label
              i.icon.asterisk
        .field
          label Project Name in English
          .ui.input
            input(name="name-en")
      .two.fields
        .field
          label 專案簡介
          .ui.input
            textarea(name="intro-zh-short",required)
            .ui.corner.label
              i.icon.asterisk
        .field
          label Project Summary in English
          .ui.input
            textarea(name="intro-en-short")
      .two.fields
        .field
          label 授權
          .ui.input
            input(placeholder="e.g. CC0, MIT",name="license",required)
            .ui.corner.label
              i.icon.asterisk
          .description
            i.icon.hand.up
            | 若同時有多種授權，以半形逗號隔開
        .field
          label 專案分類
          .ui.selection.dropdown
            input(name="category", type="hidden", value="開放政府")
            .default.text 其他
            i.icon.dropdown
            .menu.ui.transition.hidden
              .item(data-value="開放政府") 開放政府
              .item(data-value="開放資料") 開放資料
              .item(data-value="社會參與") 社會參與
              .item(data-value="政策共筆") 政策共筆
              .item(data-value="新媒體") 新媒體
              .item(data-value="g0v基礎建設") g0v基礎建設
              .item(data-value="其他") 其他
      .ui.horizontal.divider 現有成果
      #achievements
        .inline.fields
          .field
            label 網址
            .ui.left.labeled.icon.input
              input(placeholder="http://",type="url",name="achievement-0-url",required)
              i.icon.url
              .ui.corner.label
                i.icon.asterisk
          .field
            label 類型
            .ui.selection.dropdown
              input(name="achievement-0-type", type="hidden", value="web")
              .default.text website
              i.icon.dropdown
              .menu.ui.transition.hidden
                .item(data-value="web") website
                .item(data-value="android") Android app
                .item(data-value="ios") iOS app
                .item(data-value="wp") Windows Phone app
                .item(data-value="firefoxos") Firefox OS
                .item(data-value="linux") Linux software
                .item(data-value="mac") Mac software
                .item(data-value="windows") Windows software
                .item(data-value="chrome") Chrome extension
                .item(data-value="firefox") Firefox extension
                .item(data-value="safari") Safari extension
                .item(data-value="api") application interface (api)
                .item(data-value="document") document
                .item(data-value="miscmiscellaneous") miscellaneous
          .field
            label 開發階段
            .ui.selection.dropdown
              input(name="achievement-0-phase", type="hidden", value="idea")
              .default.text idea
              i.icon.dropdown
              .menu.ui.transition.hidden
                .item(data-value="idea") idea
                .item(data-value="plan") plan
                .item(data-value="wireframe") wireframe
                .item(data-value="mockup") mockup
                .item(data-value="prototype") prototype
                .item(data-value="alpha") alpha
                .item(data-value="beta") beta
                .item(data-value="production") production
                .item(data-value="memory") memory
                .item(data-value="miscellaneous") miscellaneous
      #add-achievement.ui.button 新增一筆
      .ui.horizontal.divider 工作區
      #workspaces
        .inline.fields
          .field
            label 網址
            .ui.left.labeled.icon.input
              input(placeholder="http://",type="url",name="workspace-0-url",required)
              i.icon.url
              .ui.corner.label
                i.icon.asterisk
          .field
            label 類型
            .ui.selection.dropdown
              input(name="workspace-0-type", type="hidden", value="github")
              .default.text github
              i.icon.dropdown
              .menu.ui.transition.hidden
                .item(data-value="hackpad") hackpad
                .item(data-value="hackfoldr") hackfoldr
                .item(data-value="github") github
                .item(data-value="drive") google drive
                .item(data-value="groups") google groups
                .item(data-value="plus") google plus community
                .item(data-value="calendar") google calendar
                .item(data-value="facebook") facebook group
                .item(data-value="irc") irc channel
                .item(data-value="miscellaneous") miscellaneous
      #add-workspace.ui.button 新增一筆
      .ui.horizontal.divider 以下選填
      .field
        label 使用工具
        .ui.input
          input(name="tool", placeholder="e.g. moqups, illustrator, photoshop, garageband, sass, jade, semantic ui, fire.app, gulp, jquery, underscore js, handlebar js, angular js, react js, rails, django, travis ci, ")
        .description
          i.icon.hand.up
          | 以半形逗號隔開
      .two.fields
        .field
          label 專案 logo 圖檔網址
          .ui.left.labeled.icon.input
            input(placeholder="http://",type="url",name="logo")
            i.icon.url
          .description
            i.icon.hand.up
            | 若不填，會自動以網頁抓圖代替
        .field
          label 專案首頁網址
          .ui.left.labeled.icon.input
            input(placeholder="http://",type="url",name="homepage")
            i.icon.url
          .description
            i.icon.hand.up
            | 若不填，會自動以第一個成果網址代替
      .two.fields
        .field
          label 標籤
          .ui.input
            input(name="tag")
          .description
            i.icon.hand.up
            | 以半形逗號隔開
        .field
          label 相關專案
          .ui.input
            input(name="related")
          .description
            i.icon.hand.up
            | 以半形逗號隔開
      #submit-project.ui.submit.right.icon.labeled.button.green submit project
        i.icon.add

  section#edit.views
    iframe#iframe(src="")

block script
  script.

    $(document).ready(function(){

      // step 0: setup 

      var attribute_template_source ='<a class="item" name="{{attribute_id}}">{{attribute_text}}<div class="ui label">{{count}}</div></a>';
      var attribute_template = Handlebars.compile(attribute_template_source);

      var filter_template_source = '<div class="ui label" name="{{attribute_id}}">{{attribute_text}}<i class="icon delete"></i></div>';
      var filter_template = Handlebars.compile(filter_template_source);

      var list_template_source ='<article class="column"><div class="wrapper"><a href="{{homepage}}" target="_blank" class="ui image"><img src="{{logo}}"></a><div class="text"><h3 class="ui header">{{name}}</h3><p class="description">{{intro}}</p><p class="achievement"></p></div><div class="hidden text">{{content}}</div></div></article>';
      var list_template = Handlebars.compile(list_template_source);

      var label_template_source = '<a href="{{url}}" target="_blank" class="ui label">{{type}} - {{phase}}</a>';
      var label_template = Handlebars.compile(label_template_source);

      var menus = {
        category : [],
        type : [],
        phase : [],
        license : [],
        tool : [],
        tag : [],
      };
      //var menus = {
      //  category : ["open government", "open data", "civil participation", "media 2.0", "g0v infrastructure", "policy wiki", "miscellaneous"],
      //  type : ["website", "android app", "ios app", "windows phone app", "linux software", "mac software", "windows software", "chrome extension", "firefox extension", "api", "document", "miscellaneous"],
      //  phase : ["idea", "plan", "wireframe", "mockup", "prototype", "alpha", "beta", "production", "maintenance", "memory", "miscellaneous"],
      //  license : ["CC0", "CC-By", "CC-By-NC", "CC-By-ND", "CC-By-SA", "CC-By-NC-SA", "CC-By-NC-ND", "Apache", "BSD", "GPL", "LGPL", "MIT", "miscellaneous"],
      //  tool : [],
      //  tag : [],
      //};

      //var current_view = location.pathname.split('/')[1] || "";
      var current_view = location.pathname.split('/')[3] || "";
      var update_view = function(current_url){
        $(".views").fadeOut();
        $("#"+current_url).fadeIn();
      };
      var update_url = function(current_view){
        //history.pushState( {}, current_view + '| g0v project hub mockup', '/' + current_view );
        history.pushState( {}, current_view + '| g0v project hub mockup', '/project-hub-mockup/public/' + current_view );
      };
      $.each( ["submit", "edit", "about"], function(view_index, view_value){
        if(current_view == view_value){
          update_view(view_value);
          update_url(view_value);
        }
      });

      var render_attributes = function(target_menu_name, attributes){
        $.each(attributes, function(attribute_index, attribute){
          var attribute_id = target_menu_name + "-" + attribute_index;
          var attribute_text = attribute;
          var count = $("#list ." + attribute_id).length; 
          var context = {attribute_id: attribute_id, attribute_text: attribute_text, count: count};
          var $attribute_element = $(attribute_template(context));
          var $filter_element = $(filter_template(context));
          $("#" + target_menu_name + " .content .menu").append($attribute_element);
          $("#filter").append($filter_element);
        });
        var menu_items_count = $("#" + target_menu_name + " .content .menu .item").length;
        $("#" + target_menu_name + " .title").append(" (" + menu_items_count + ")");
      }

      // step 1: get data and render projects

      $.getJSON("json/project-list.json", function(projects){

        $.each(projects, function(project_index, project){
          var homepage = project.homepage;
          var logo = project.logo;
          var name = project.name.zh;
          var intro = project.intro.zh.short;
          var classes = [];
          var content = "";

          var add_classes = function(attribute_type){
            $.each(project[attribute_type], function(index, attribute){
              if( !_.contains(menus[attribute_type], attribute)){
                menus[attribute_type].push(attribute);
              }
              var attribute_id = attribute_type + "-" + menus[attribute_type].indexOf(attribute);
              classes.push(attribute_id);
            });
          };
          var add_sub_classes =  function(attribute_type, attribute){
            if( !_.contains(menus[attribute_type], attribute)){
              menus[attribute_type].push(attribute);
            }
            var attribute_id = attribute_type + "-" + menus[attribute_type].indexOf(attribute);
            if( !_.contains(classes, attribute_id) ){
              classes.push(attribute_id);
            };
          };
          add_classes("category");
          add_classes("tag");
          add_classes("tool");
          add_classes("license");

          if(homepage.length == 0){
            homepage = project.achievement[0].url;
          };
          if(logo.length == 0){
            logo = "http://i.jimmyhub.net/shot/" + homepage;
          };

          var context = {homepage: homepage, logo: logo, name: name, intro: intro, content: content};
          var $list_element = $(list_template(context));

          $.each(project.achievement, function(achievement_index, achievement){
            var achievement_type = achievement.type;
            var achievement_phase = achievement.phase;
            var achievement_url = achievement.url;
            var context = {type: achievement_type, phase: achievement_phase, url: achievement_url};
            var $label_element = $(label_template(context));
            $list_element.find(".achievement").append($label_element);
            add_sub_classes("type", achievement_type);
            add_sub_classes("phase", achievement_phase);
          });

          $.each(classes, function(class_index, class_name){
            $list_element.addClass(class_name);
          });

          $("#list").append($list_element);
        });
      }).done(function(){

        // step 2: render sidebar menu and filter labels

        $.each(menus, function(menu_id, menu_items){
          render_attributes(menu_id, menu_items);
        });

      }).done(function(){

        // step 3: start filtering rendered projects

        // for ux
        $("#filter .ui.label").hide();

        // for projects filter
        var initialize_pilot = function(){
          var active_classes = [];
          var active_classes_string = "";
          var target_attribute = "";
          var all_projects_count = $("#list .column").length;
          var toggle_classes = function(original_classes, target_class){
            if( _.contains( active_classes, target_attribute )){
              active_classes = _.without(active_classes, target_attribute);
            }else{
              active_classes.push(target_attribute);
            };
            active_classes_string = "";
            _.each(active_classes, function(css_class){
              active_classes_string = active_classes_string + "." + css_class;
            });
            $("#list .column").fadeOut();
            $("#list .column" + active_classes_string ).fadeIn();
          };
          var count_projects = function(){
            if(active_classes_string.length > 0){
              $("#count").text("showing " + $("#list").find(active_classes_string).length + " out of " + all_projects_count +" projects");
            }else{
              $("#count").text(all_projects_count + " projects");
            }
          }
          count_projects();
          $("#index").on("click tap", function(){
            $("#projects").show();
            $("#about, #submit, #edit").fadeOut();
            //update_view("projects");
            update_url("");
          });
          $("#index .content .item").on("click tap", function(){
            $(this).toggleClass("active");
            target_attribute = $(this).attr("name");
            $("#filter .ui.label").filter("[name='" + target_attribute + "']").fadeToggle();
            toggle_classes(active_classes, target_attribute);
            count_projects();
          });
          $("#filter .ui.label .delete.icon").on("click tap", function(){
            $(this).parent().fadeOut();
            target_attribute = $(this).parent().attr("name");
            $("#index .content .item").filter("[name='" + target_attribute + "']").removeClass("active");
            toggle_classes(active_classes, target_attribute);
            count_projects();
          });
        };
        initialize_pilot();

      }).done(function(){

        // step 4: start other interactions

        // for semantic ui
        $(".ui.dropdown").dropdown();
        $(".ui.accordion").accordion();

        // change views
        $("#sidebar .menu .help").parent(".item").on("click tap", function(){
          update_view("about");
          update_url("about");
        });
        $("#sidebar .menu .add").parent(".item").on("click tap", function(){
          update_view("submit");
          update_url("submit");
        });
        $("#sidebar .menu .pencil").parent(".item").on("click tap", function(){
          update_view("edit");
          update_url("edit");
        });

        // initiate submit form - add achievement / add workspace
        var achievement_template_source = '<div class="inline fields"><div class="field"><label>網址</label><div class="ui left labeled icon input"><input placeholder="http://" type="url" name="achievement-"{{number}}"-url"><i class="icon url"></i><div class="ui corner label"><i class="icon asterisk"></i></div></div></div><div class="field"><label>類型</label><div class="ui selection dropdown"><input name="achievement-"{{number}}"-type" type="hidden" value="web"><div class="default text">website</div><i class="icon dropdown"></i><div class="menu ui transition hidden"><div data-value="web" class="item">website</div><div data-value="android" class="item">Android app</div><div data-value="ios" class="item">iOS app</div><div data-value="wp" class="item">Windows Phone app</div><div data-value="firefoxos" class="item">Firefox OS</div><div data-value="linux" class="item">Linux software</div><div data-value="mac" class="item">Mac software</div><div data-value="windows" class="item">Windows software</div><div data-value="chrome" class="item">Chrome extension</div><div data-value="firefox" class="item">Firefox extension</div><div data-value="safari" class="item">Safari extension</div><div data-value="api" class="item">application interface (api)</div><div data-value="document" class="item">document</div><div data-value="miscmiscellaneous" class="item">miscellaneous</div></div></div></div><div class="field"><label>開發階段</label><div class="ui selection dropdown"><input name="achievement-"{{number}}"-phase" type="hidden" value="idea"><div class="default text">idea</div><i class="icon dropdown"></i><div class="menu ui transition hidden"><div data-value="idea" class="item">idea</div><div data-value="plan" class="item">plan</div><div data-value="wireframe" class="item">wireframe</div><div data-value="mockup" class="item">mockup</div><div data-value="prototype" class="item">prototype</div><div data-value="alpha" class="item">alpha</div><div data-value="beta" class="item">beta</div><div data-value="production" class="item">production</div><div data-value="memory" class="item">memory</div><div data-value="miscellaneous" class="item">miscellaneous</div></div></div></div></div>';
        var achievement_template = Handlebars.compile(achievement_template_source);
        var latest_achievement_index = 0;
        $("#add-achievement").on("click tap", function(){
          latest_achievement_index += 1;
          var context = {number: latest_achievement_index};
          var $achievement_element = $(achievement_template(context));
          $("#achievements").append($achievement_element);
          $(".ui.dropdown").dropdown();
        });

        var workspace_template_source = '<div class="inline fields"><div class="field"><label>網址</label><div class="ui left labeled icon input"><input placeholder="http://" type="url" name="workspace-"{{number}}"-url"><i class="icon url"></i><div class="ui corner label"><i class="icon asterisk"></i></div></div></div><div class="field"><label>類型</label><div class="ui selection dropdown"><input name="workspace-"{{number}}"-type" type="hidden" value="github"><div class="text">github</div><i class="icon dropdown"></i><div class="menu ui transition hidden"><div data-value="hackpad" class="item">hackpad</div><div data-value="hackfoldr" class="item">hackfoldr</div><div data-value="github" class="item active">github</div><div data-value="drive" class="item">google drive</div><div data-value="groups" class="item">google groups</div><div data-value="plus" class="item">google plus community</div><div data-value="calendar" class="item">google calendar</div><div data-value="facebook" class="item">facebook group</div><div data-value="irc" class="item">irc channel</div><div data-value="miscellaneous" class="item">miscellaneous</div></div></div></div></div>';
        var workspace_template = Handlebars.compile(workspace_template_source);
        var latest_workspace_index = 0;
        $("#add-workspace").on("click tap", function(){
          latest_workspace_index += 1;
          var context = {number: latest_workspace_index};
          var $workspace_element = $(workspace_template(context));
          $("#workspaces").append($workspace_element);
          $(".ui.dropdown").dropdown();
        });

        // initiate submit form - validation and post
        var form_status = false;
        var post_ethercalc = function(new_project_row){
          $.ajax({
            url: "https://ethercalc.org/_/g0v-project-hub-mockup",
            type: 'POST',
            contentType: 'text/csv',
            processData: false,
            data: new_project_row,
            success: function(){
              $("input, textarea").val("");
              update_view("edit");
              update_url("edit");
              //console.log($.get("https://ethercalc.org/_/g0v-project-hub-mockup/csv"));
            }
          });
        };
        $('.ui.form').form(
          {
            name: {
              identifier: 'name-zh',
              rules: [
                {
                  type: 'empty'
                }
              ]
            },
            intro: {
              identifier: 'intro-zh-short',
              rules: [
                {
                  type: 'empty'
                }
              ]
            },
            license: {
              identifier: 'license',
              rules: [
                {
                  type: 'empty'
                }
              ]
            },
            achievement: {
              identifier: 'achievement-0-url',
              rules: [
                {
                  type: 'url'
                }
              ]
            },
            workspace: {
              identifier: 'workspace-0-url',
              rules: [
                {
                  type: 'url'
                }
              ]
            },
          },
          {
            onSuccess: function(){form_status = true;},
            onFailure: function(){form_status = false;}
          }
        );
        $('.ui.form').submit(function(e){
          if(form_status){
            var submit_data = {};
            var submit_data_string = ['id'];
            submit_data.name = {};
            submit_data.name.zh = $("[name='name-zh']").val();
            submit_data.name.en = $("[name='name-en']").val();
            submit_data.intro = {};
            submit_data.intro.zh = {};
            submit_data.intro.en = {};
            submit_data.intro.zh.short = $("[name='intro-zh-short']").val();
            submit_data.intro.en.short = $("[name='intro-en-short']").val();
            submit_data.license = $("[name='license']").val();
            submit_data.category = $("[name='category']").val();
            submit_data.achievement = [];
            for(var i = 0; i < latest_achievement_index+1; i++){
              submit_data.achievement[i] = {};
              submit_data.achievement[i].url = $("[name='achievement-"+i+"-url']").val();        
              submit_data.achievement[i].type = $("[name='achievement-"+i+"-type']").val();        
              submit_data.achievement[i].phase = $("[name='achievement-"+i+"-phase']").val();        
            };
            submit_data.workspace = [];
            for(var i = 0; i < latest_workspace_index+1; i++){
              submit_data.workspace[i] = {};
              submit_data.workspace[i].url = $("[name='workspace-"+i+"-url']").val();        
              submit_data.workspace[i].type = $("[name='workspace-"+i+"-type']").val();        
            };
            submit_data.tool = $("[name='tool']").val();
            submit_data.logo = $("[name='logo']").val();
            submit_data.homepage = $("[name='homepage']").val();
            submit_data.tag = $("[name='tag']").val();
            submit_data.related = $("[name='related']").val();
            $.each(submit_data, function(key, data){
              //submit_data_string = submit_data_string + JSON.stringify(data).replace(/,/g, ";").replace(/{/g, "(").replace(/\"/g, "\"\"").replace(/\[/g, "<") + ", ";
              submit_data_string.push('"' + JSON.stringify(data).replace(/"/g, '""') + '"');
            });
            //console.log(submit_data_string);
            post_ethercalc(submit_data_string.join(','));
          };
          return false;
          //e.preventDefault();
          //console.log(JSON.stringify(submit_data));
        });

        // TODO: sort menu items

      }).done(function(){
        $("#iframe").attr("src","https://ethercalc.org/g0v-project-hub-mockup");
        //console.log($.get("https://ethercalc.org/_/g0v-project-hub-mockup/csv"));
      });

      // TODO: login and join projects
      var roles = ["research", "planning", "ui", "visual", "art", "web frontend", "web backend", "ios", "android", "mac", "linux", "windows", "txt", "consult", "miscellaneous"];

    });
